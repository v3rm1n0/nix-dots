# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is a modular NixOS configuration using Flakes, Home Manager, and multiple custom modules. The configuration supports multiple hosts (Desktop and Laptop) with shared base configuration and host-specific overrides.

## Build and Development Commands

### Applying Configuration Changes

```bash
# Quick rebuild (using nh wrapper with alias)
os

# Update and rebuild
ou

# Manual rebuild for specific host
sudo nixos-rebuild switch --flake .#Desktop
sudo nixos-rebuild switch --flake .#Laptop

# Test configuration without switching
sudo nixos-rebuild test --flake .#Desktop

# Build for next boot only
sudo nixos-rebuild boot --flake .#Desktop
```

### Flake Management

```bash
# Update all flake inputs
nix flake update

# Update specific input
nix flake lock --update-input nixpkgs

# Validate flake configuration
nix flake check

# Format Nix files
nix fmt
```

### Maintenance

```bash
# Manual garbage collection
nix-collect-garbage -d
sudo nix-collect-garbage -d

# Btrfs maintenance (runs automatically weekly)
sudo btrfs scrub start /
sudo btrfs balance start -dusage=75 /
sudo fstrim -av
```

## Architecture

### Module System Design

The configuration uses a **three-tier module hierarchy**:

1. **System-level modules** (`system/`): Core OS functionality (boot, hardware, services)
2. **Feature modules** (`modules/`): Optional functionality with enable flags (applications, desktop, security, shell)
3. **Host configurations** (`hosts/`): Per-machine settings that import and configure modules

### Configuration Flow

```
flake.nix (entry point)
  └── default.nix (imports agenix, home-manager, stylix, ./assets, ./modules, ./system)
      ├── hosts/{Desktop,Laptop}/default.nix
      │   ├── users/v3rm1n/default.nix (home-manager user config)
      │   ├── hosts/common/ (shared locale, shell, services, security, programs)
      │   ├── modules/ (host-specific module configs)
      │   ├── hardware-configuration.nix (generated by nixos-generate-config)
      │   └── hardware-specific.nix (manual hardware tweaks)
      ├── modules/ (feature modules with enable options)
      └── system/ (core system configuration)
```

### Module Enable Pattern

Most feature modules follow this pattern:

```nix
{
  options.programs.gaming = {
    enable = mkEnableOption "Gaming profile";
    optionalPackages = mkOption { ... };  # Additional packages
  };

  config = mkIf config.programs.gaming.enable {
    # Configuration when enabled
  };
}
```

Modules are enabled in host-specific configs like `hosts/Desktop/modules/programs.nix`.

### User Options System

Each host defines a `userOptions` attribute set in `modules/userOptions.nix`:

```nix
config.userOptions = {
  browser = "librewolf";         # Default browser
  colorScheme = "kanagawa";      # Stylix theme
  dots = "/home/${username}/.dotfiles";
  hostName = "Desktop";
  username = "v3rm1n";
  wallpaper = "kanagawa.png";    # From assets/
};
```

These options are consumed throughout the configuration via `config.userOptions.*`.

### Hardware Configuration

Hardware is configured through the `hardwareModule` option namespace:

```nix
config.hardwareModule = {
  gpu = {
    enable = true;
    brand = "nvidia";  # or "intel", "amd"
  };
  razer.enable = true;  # Desktop only
};
```

GPU-specific configuration is automatically applied based on the `brand` setting in `system/hardware/graphics/default.nix`.

## Key Subsystems

### Secure Boot (Lanzaboote)

- Configuration in `system/boot/boot.nix`
- Uses `lanzaboote` for UEFI Secure Boot with TPM2
- Boot entries managed through `boot.loader.efi`

### Secret Management (agenix)

- Secrets stored encrypted in `secrets/` directory
- Public keys defined in `secrets/secrets.nix`
- Secrets decrypted at activation time to `/run/agenix/`
- Edit secrets: `cd secrets && agenix -e secretfile.age`

### Styling System (Stylix)

- Unified theming across all applications
- Color scheme set via `config.userOptions.colorScheme`
- Wallpaper set via `config.userOptions.wallpaper` (files in `assets/`)
- Automatically applies to terminal, editors, browser, desktop environment

### Hyprland Desktop Environment

- Entry point: `modules/desktop/hypr/default.nix`
- Session management via UWSM (Universal Wayland Session Manager)
- Includes hypridle (idle management) and hyprlock (screen lock)
- Display configuration in `hosts/{Desktop,Laptop}/modules/monitors.nix`

### Home Manager Integration

- User configurations in `users/v3rm1n/default.nix`
- Home Manager modules imported through `default.nix`
- Uses `home-manager.users.${config.userOptions.username}` pattern
- Applications configured declaratively through Home Manager

## Common Patterns

### Adding a New Application Module

1. Create `modules/applications/<category>/<app>.nix` or `modules/applications/<category>/default.nix`
2. Define option with `mkEnableOption`
3. Add packages to `environment.systemPackages` or Home Manager
4. Enable in host config: `config.programs.<app>.enable = true;`

### Creating a New Host

1. Copy existing host directory: `cp -r hosts/Desktop hosts/NewHost`
2. Update `flake.nix` to add new host to `nixosConfigurations`
3. Modify `modules/userOptions.nix` with new hostName
4. Adjust hardware configuration and module enables
5. Build: `nixos-rebuild switch --flake .#NewHost`

### Module Import Structure

- `default.nix` files automatically import all `.nix` files in their directory via `imports = [ ... ]`
- Host modules are separated by concern: `hardware.nix`, `programs.nix`, `services.nix`, `monitors.nix`, `userOptions.nix`
- Common configuration shared between hosts lives in `hosts/common/`

## Important Files

- `flake.nix` - Flake inputs and host definitions
- `default.nix` - Top-level module imports (agenix, home-manager, stylix)
- `hosts/{Desktop,Laptop}/modules/userOptions.nix` - Host-specific user configuration
- `system/nix/settings.nix` - Nix daemon settings, binary caches, trusted users
- `system/nix/gc.nix` - Automatic garbage collection (10-day generation retention)
- `system/nix/btrfs.nix` - Automated Btrfs scrub, balance, and trim
- `modules/shell/commonAliases.nix` - Shell aliases shared across bash/zsh

## Dependencies and Inputs

Key flake inputs:
- `nixpkgs` - NixOS unstable channel
- `home-manager` - Declarative user environment management
- `stylix` - System-wide theming
- `agenix` - Secret management
- `lanzaboote` - Secure Boot support
- `hyprland` - Wayland compositor (via nixpkgs)
- `spicetify-nix` - Spotify theming
- `vicinae` - Local network file sharing service
- `helium` - Helium browser package

## Testing Changes

1. Always test with `nixos-rebuild test` first for non-boot changes
2. For boot changes, use `nixos-rebuild boot` and verify after reboot
3. Check flake validity with `nix flake check`
4. Validate syntax with formatter: `nix fmt`
5. Review git diff before committing: `git diff` (check both staged and unstaged)

## Troubleshooting

### Build Failures

- Check flake lock file is up to date: `nix flake update`
- Verify binary cache access: `nix-store --verify-store`
- Review build logs carefully for specific error messages

### Module Conflicts

- Ensure only one module sets the same option
- Use `lib.mkDefault` for default values that can be overridden
- Use `lib.mkForce` to forcefully override a value
- Check `nixos-option <option.path>` to see what's setting an option

### Hardware Issues

- GPU configuration is in `system/hardware/graphics/default.nix`
- Hardware-specific tweaks go in `hosts/{host}/hardware-specific.nix`
- Generated hardware config is in `hosts/{host}/hardware-configuration.nix` (do not hand-edit)
