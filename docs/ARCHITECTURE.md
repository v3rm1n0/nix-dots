# Architecture Documentation

This document explains the architectural decisions and structure of this NixOS configuration.

## Table of Contents

- [Overview](#overview)
- [Design Principles](#design-principles)
- [Directory Structure](#directory-structure)
- [Module System](#module-system)
- [Configuration Flow](#configuration-flow)
- [Adding New Features](#adding-new-features)

## Overview

This NixOS configuration uses a modular, declarative approach built on:
- **NixOS Flakes** for reproducible builds and dependency management
- **Home Manager** for user-level configuration
- **Custom module system** with enable options for easy customization

## Design Principles

### 1. Modularity
Every feature is self-contained in its own module with a clear `enable` option. This allows:
- Easy feature toggling per host
- Reduced cognitive load (only activate what you need)
- Clear separation of concerns

### 2. Host Separation
Different machines have different needs:
- **Desktop**: Gaming, high-performance graphics, development
- **Laptop**: Power management, portability, lightweight alternatives

Common configuration lives in `hosts/common/`, host-specific in `hosts/{Desktop,Laptop}/`.

### 3. Declarative Everything
From boot configuration to application settings, everything is declared in Nix. This ensures:
- Reproducibility across machines
- Easy rollback to previous generations
- Configuration as documentation

### 4. Security by Default
- Secrets managed via agenix (never committed to git)
- Secure Boot enabled via Lanzaboote
- Minimal exposed services

## Directory Structure

```
.
├── flake.nix              # Entry point - defines hosts and inputs
├── default.nix            # Imports core modules (agenix, home-manager, stylix)
│
├── hosts/                 # Host-specific configurations
│   ├── Desktop/
│   │   ├── default.nix             # Imports all Desktop config
│   │   ├── hardware-configuration.nix  # Generated by nixos-generate-config
│   │   ├── hardware-specific.nix   # Desktop-only hardware (e.g., Razer)
│   │   └── modules/
│   │       ├── hardware.nix        # Hardware module enables
│   │       ├── monitors.nix        # Monitor configuration
│   │       ├── programs.nix        # Enabled programs
│   │       └── userOptions.nix     # Theme, wallpaper, etc.
│   │
│   ├── Laptop/            # Similar structure for laptop
│   └── common/            # Shared configuration
│       ├── env.nix         # Environment variables
│       └── locale.nix      # Localization settings
│
├── modules/               # Feature modules
│   ├── applications/      # User applications
│   │   ├── browsing/      # Browsers (Firefox, Chromium, Tor)
│   │   ├── dev/           # Development tools
│   │   ├── gaming/        # Gaming platforms
│   │   └── ...
│   │
│   ├── desktop/           # Desktop environment
│   │   ├── greetd/        # Login manager
│   │   ├── hyprland/      # Hyprland WM config
│   │   ├── stylix/        # Theming
│   │   └── xdg/           # XDG portal configuration
│   │
│   ├── hardware/          # Hardware-specific features
│   │   ├── gpu/           # GPU configuration (NVIDIA/Intel/AMD)
│   │   └── razer/         # Razer peripheral support
│   │
│   ├── security/          # Security modules
│   │   ├── agenix/        # Secret management
│   │   ├── gpg/           # GPG configuration
│   │   └── passwords/     # Password manager setup
│   │
│   ├── services/          # User services
│   │   ├── bluetooth/     # Bluetooth management
│   │   ├── flatpak/       # Flatpak support
│   │   └── vicinae/       # Vicinae service
│   │
│   ├── shell/             # Shell configuration
│   │   ├── bash/          # Bash config
│   │   ├── zsh/           # Zsh config
│   │   └── aliases/       # Shared aliases
│   │
│   └── user/              # User module system
│       └── userOptions.nix # Defines userOptions interface
│
├── system/                # Core system configuration
│   ├── boot/              # Boot process
│   │   ├── kernel/        # Kernel selection
│   │   ├── plymouth/      # Boot splash
│   │   └── secure-boot/   # Lanzaboote configuration
│   │
│   ├── hardware/          # System hardware support
│   │   ├── audio/         # Audio (PipeWire)
│   │   ├── bluetooth/     # Bluetooth stack
│   │   ├── graphics/      # Graphics drivers
│   │   └── webcam/        # Webcam configuration
│   │
│   ├── nix/               # Nix system settings
│   │   ├── btrfs.nix      # Btrfs maintenance
│   │   ├── gc.nix         # Garbage collection
│   │   └── settings.nix   # Nix daemon settings
│   │
│   ├── programs/          # System utilities
│   │   ├── monitoring/    # System monitoring tools
│   │   └── utils/         # Common utilities
│   │
│   └── services/          # System services
│       ├── power/         # Power management
│       └── ssh/           # SSH daemon
│
├── users/                 # User account definitions
│   └── v3rm1n/
│       └── default.nix    # User account and home-manager config
│
├── secrets/               # Encrypted secrets (agenix)
│   ├── secrets.nix        # Public keys and secret definitions
│   └── *.age              # Encrypted secret files
│
└── assets/                # Static resources
    └── *.png              # Wallpapers
```

## Module System

### Module Pattern

All feature modules follow a consistent pattern:

```nix
{ lib, config, pkgs, ... }:

with lib;

let
  # Default packages or configuration
  defaultPackages = [ pkgs.foo pkgs.bar ];
in
{
  options.programs.myFeature = {
    enable = mkEnableOption "Enable my feature";

    optionalPackages = mkOption {
      type = types.listOf types.package;
      default = [ ];
      description = "Additional packages to install";
    };
  };

  config = mkIf config.programs.myFeature.enable {
    environment.systemPackages = defaultPackages ++ config.programs.myFeature.optionalPackages;

    # Additional configuration...
  };
}
```

### Module Categories

1. **Application Modules** (`modules/applications/`)
   - Install and configure user applications
   - Typically add packages to `environment.systemPackages` or via Home Manager

2. **Desktop Modules** (`modules/desktop/`)
   - Configure the desktop environment
   - Handle WM/DE, theming, login managers

3. **Hardware Modules** (`modules/hardware/`)
   - Enable hardware support (GPU, peripherals)
   - Load kernel modules and firmware

4. **Security Modules** (`modules/security/`)
   - Manage secrets, encryption, authentication
   - Configure security-sensitive applications

5. **Service Modules** (`modules/services/`)
   - User-level services (distinct from `system/services/`)
   - Typically managed via systemd user units

6. **System Modules** (`system/`)
   - Core system functionality
   - Always enabled, not optional features

## Configuration Flow

### Build Process

1. **flake.nix** is evaluated
2. Host-specific configuration is selected (`Desktop` or `Laptop`)
3. Modules are imported in this order:
   ```
   flake.nix
     └─> default.nix (imports agenix, home-manager, stylix, assets, modules, system)
         └─> hosts/{Desktop,Laptop}/default.nix
             ├─> users/v3rm1n/default.nix
             ├─> hosts/common/ (locale, env)
             ├─> hosts/{Desktop,Laptop}/modules/
             │   ├─> hardware.nix (enable hardware features)
             │   ├─> monitors.nix (monitor setup)
             │   ├─> programs.nix (enable programs)
             │   └─> userOptions.nix (theme, wallpaper)
             ├─> hardware-configuration.nix
             └─> hardware-specific.nix
   ```

4. Each module's `config` section is activated based on `enable` options
5. Home Manager processes user-level configuration
6. System is built and can be switched to

### Option Resolution

NixOS merges all module options. Last definition wins, but lists are merged:

```nix
# In modules/applications/dev/default.nix
environment.systemPackages = [ pkgs.vscode ];

# In hosts/Desktop/modules/programs.nix
programs.dev.optionalPackages = [ pkgs.jetbrains.idea ];

# Result: both are installed
```

## Adding New Features

### Adding a New Application Module

1. **Create the module file:**
   ```bash
   mkdir -p modules/applications/myapp
   touch modules/applications/myapp/default.nix
   ```

2. **Write the module:**
   ```nix
   { lib, config, pkgs, ... }:

   with lib;

   {
     options.programs.myapp = {
       enable = mkEnableOption "Enable MyApp";
     };

     config = mkIf config.programs.myapp.enable {
       environment.systemPackages = [ pkgs.myapp ];

       # Optional: Home Manager configuration
       home-manager.users.${config.userOptions.username} = {
         programs.myapp = {
           enable = true;
           settings = {
             # ...
           };
         };
       };
     };
   }
   ```

3. **Import the module:**
   Add to `modules/applications/default.nix`:
   ```nix
   imports = [
     # ...
     ./myapp
   ];
   ```

4. **Enable in host config:**
   In `hosts/Desktop/modules/programs.nix`:
   ```nix
   programs.myapp.enable = true;
   ```

### Adding a New Host

1. **Copy existing host:**
   ```bash
   cp -r hosts/Desktop hosts/NewHost
   ```

2. **Generate hardware config:**
   ```bash
   nixos-generate-config --show-hardware-config > hosts/NewHost/hardware-configuration.nix
   ```

3. **Update `flake.nix`:**
   ```nix
   nixosConfigurations = {
     # ...
     NewHost = inputs.nixpkgs.lib.nixosSystem {
       specialArgs = { inherit system; } // inputs;
       modules = [ ./. ./hosts/NewHost ];
     };
   };
   ```

4. **Customize configuration:**
   - Edit `hosts/NewHost/modules/programs.nix` to enable desired features
   - Update `hosts/NewHost/modules/userOptions.nix` for theming
   - Modify `hosts/NewHost/modules/hardware.nix` for hardware support

### Adding Secrets

1. **Add public key to `secrets/secrets.nix`:**
   ```nix
   let
     newkey = "ssh-ed25519 AAAA... user@host";
     users = [ newkey ];
   in
   {
     "newsecret.age".publicKeys = users;
   }
   ```

2. **Create and encrypt the secret:**
   ```bash
   cd secrets
   agenix -e newsecret.age
   ```

3. **Reference in configuration:**
   ```nix
   age.secrets.newsecret = {
     file = ../secrets/newsecret.age;
     owner = config.userOptions.username;
   };
   ```

4. **Use in configuration:**
   ```nix
   services.myservice = {
     enable = true;
     passwordFile = config.age.secrets.newsecret.path;
   };
   ```

## Best Practices

### Do's
- Keep modules focused on a single feature
- Use `mkEnableOption` for all optional features
- Document complex options with descriptions
- Test changes with `nixos-rebuild test` before switching
- Keep secrets encrypted and never commit them

### Don'ts
- Don't mix system and user configuration in one module
- Don't enable services globally if only one host needs them
- Don't hardcode paths (use variables and options)
- Don't use imperative commands (prefer declarative config)

## Performance Considerations

- **Build times**: Modular approach allows Nix to cache unchanged modules
- **Flake inputs**: All inputs follow `nixpkgs` to ensure compatibility and reduce cache misses
- **Garbage collection**: Automated daily cleanup keeps system lean
- **Btrfs**: Regular scrub and balance optimize storage

## Troubleshooting

### Module Not Loading
1. Check if module is imported in parent `default.nix`
2. Verify `enable` option is set to `true`
3. Check for typos in option names
4. Run `nixos-rebuild build --flake .#Host` to see detailed errors

### Option Conflicts
If you get "option defined multiple times" errors:
1. Use `mkDefault` for default values: `mkDefault true`
2. Use `mkForce` to override: `mkForce false`
3. Check if module is imported multiple times

### Rebuild Failures
```bash
# Test without switching
sudo nixos-rebuild test --flake .#Desktop

# Check what will be built
nix flake show

# Validate flake
nix flake check
```

## Further Reading

- [NixOS Manual - Module System](https://nixos.org/manual/nixos/stable/#sec-writing-modules)
- [Nix Pills - Developing with Nix](https://nixos.org/guides/nix-pills/)
- [Home Manager Manual](https://nix-community.github.io/home-manager/)
